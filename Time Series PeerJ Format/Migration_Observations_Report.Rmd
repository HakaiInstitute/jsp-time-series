---
title: Juvenile Salmon Migration Observations in the Discovery Islands and Johnstone Strait in 2018
preprint: true
author:
  - name: Brett T. Johnson
    affiliation: 1
    corresponding: true
    email: brett.johnson@hakai.org
  - name: Julian C.L. Gan
  - name: Carly V. Janusson
  - name: Brian P.V. Hunt
    affiliation: 1, 2, 3
affiliation:
  - code: 1
    address: Hakai Institute Quadra Island Ecological Observatory, Heriot Bay, BC V0P 1H0
  - code: 2
    address: Institute for the Oceans and Fisheries, University of British Columbia Vancouver, B.C., Canada V6T 1Z4
  - code: 3
    address: Department of Earth, Ocean and Atmospheric Sciences, University of British Columbia Vancouver, B.C., Canada V6T 1Z4
abstract: >
  Most out-migrating juvenile Fraser River sockeye (_Oncorhynchus_ _nerka_), pink (_O._ _gorbuscha_), and chum (_O._ _keta_) salmon pass northwest through the Strait of Georgia, the Discovery Islands, and Johnstone Strait—a region of poor survival for juvenile salmon relative to the Strait of Georgia. To better understand the factors that drive early marine survival through this region, the Hakai Institute Juvenile Salmon Program monitors key aspects of this migration by capturing migrating salmon between May and July each year using a purse seine. Here we report on the 2018 migration in comparison to averages from our 2015–2018 time series. In 2018 sockeye, pink, and chum migration timing was not significantly different than time series averages. The median capture date across years in the Discovery Islands was May 23 for sockeye, and June 12 for pink and chum. Pink salmon comprised the highest proportion of the catch and the highest average catch intensity in 2018, followed by chum and then sockeye. Sockeye were longer than average in 2018, whereas pink and chum were smaller than average (all _p_ < 0.001). In the Discovery Islands, sea-louse abundance in 2018 was lower than average for sockeye, pink, and chum. In Johnstone Strait, sea-louse abundance was lower for chum but higher than average for sockeye and pink. Notably, there were no _Lepeophtheirus salmonis_ sea lice observed in Johnstone Strait in 2018.  Sea-surface temperatures in the northern Strait of Georgia during the smolt migration period of 2018 were the warmest on record in the study period.
header-includes: >
  \usepackage{lipsum}
  \usepackage{float}
bibliography: references.bib
# output: word_document
output:
  rticles::peerj_article:
    base_format: bookdown::pdf_document2 # for using \@ref()
---

```{r setup, include = FALSE, messages = FALSE}
knitr::opts_chunk$set(fig.pos = 'H', echo = FALSE, warning = FALSE, message = FALSE, error = FALSE)
# All data used for this analysis is from the hakaisalmon R package v0.2.0 at https://hakaiinstitute.github.io/hakaisalmon/
library(hakaisalmon)
library(tidyverse)
library(lubridate)
library(knitr)
library(here)
library(car)
library(ggridges)
library(forcats)

theme_set(ggsidekick::theme_sleek()) #Thanks Sean Anderson

# Survey Data
survey_seines <- read_csv(here("data", "survey_seines.csv")) %>%
  rename("Sockeye" = "so_total", "Pink" = "pi_total", "Chum" = "cu_total")
sealice_summary_table <- read_csv(here("data", "sealice_summary_table.csv"))
# Temp data
ctd_all <- read_csv(here("data", "ctd_all.csv"))
temperature_anomaly_data <- read_csv(here("data", "temperature_anomaly_data.csv"))
min_max_data <- read_csv(here("data", "min_max_temps.csv"))
average_temps <- read_csv(here("data", "average_temps.csv"))
proportion <- read_csv(here("data", "proportion.csv"))
# Migration Timing Data
predict_average_prop <- read_csv(here("data", "predict_average_prop.csv"))
predict_annual_prop <- read_csv(here("data", "predict_annual_prop.csv"))
peak_dates <- read_csv(here("data", "peak_dates.csv"))
catch_intensity <- read_csv(here("data", "catch_intensity.csv"))
# I can't get 2017 chum logistic growth line so use points instead
cu_cum_abund_annual_DI_2017 <- read_csv(here("data", "cu_cum_abund_DI_2017.csv"))
# Length Data
length_histo <- read_csv(here("data", "length_histo.csv"))
fish_cond <- read_csv(here("data", "fish_cond_data.csv"))
# Standardized z-scores
heatmap_data <- read.csv(here("data", "heatmap_data.csv")) 

heatmap_data$metric <- heatmap_data$metric %>%
  fct_relevel("Sockeye Migration Timing", "Pink Migration Timing", "Chum Migration Timing", "Sockeye Catch Intensity", "Pink Catch Intensity", "Chum Catch Intensity", "Sockeye Length", "Pink Length", "Chum Length", "Sockeye Parasite Loads", "Pink Parasite Loads", "Chum Parasite Loads", "SST") %>%
  fct_rev() 


spp_labels <- c(CU = "Chum", PI = "Pink", SO = "Sockeye", DI = "Discovery Islands", 
                JS = "Johnstone Strait")

pl_colours <- c("pi_total" = "pink", "so_total" = "#00BFC4", "cu_total" = "#7CAE00", 
                    "co_total" = "#F8766D", "he_total" = "#C77CFF")

current_year <- max(year(survey_data$survey_date))
project_years <- current_year - 2015 + 1
study_range <- paste(2015, "-", current_year)
```

```{r migration timing stats, include=FALSE}

# calcualte the time series average quartiles for each species
tsa_migration_timing <- peak_dates %>% 
  group_by(species) %>% 
  summarise(q1= mean(q1),
            median= mean(median),
            q3= mean(q3),
            n = n()) %>% 
  mutate(year = paste(2015, "-", current_year), region = "DI") %>% 
  ungroup()%>% 
  arrange(year, desc(species))

# combine time series average with annual observations into one df
migration_timing <- peak_dates %>% 
  mutate_if(is.numeric, round) 

# Define time series and current year peak migration dates for intext inline code 

# Sockeye
so_q2_DI_TSA <- as.numeric(migration_timing %>% 
  filter(species == "SO" & year == paste(2015, "-", current_year)) %>% 
  select(median))

so_q2_DI_current <- as.numeric(migration_timing %>% 
  filter(species == "SO" & year == current_year) %>% 
  select(median))

# Pink
pi_q2_DI_TSA <- as.numeric(migration_timing %>% 
  filter(species == "PI" & year == paste(2015, "-", current_year)) %>% 
  select(median))

pi_q2_DI_current <- as.numeric(migration_timing %>% 
  filter(species == "PI" & year == current_year) %>% 
  select(median))

# Chum
cu_q2_DI_TSA <- as.numeric(migration_timing %>% 
  filter(species == "CU" & year == paste(2015, "-", current_year)) %>% 
  select(median))

cu_q2_DI_current <- as.numeric(migration_timing %>% 
  filter(species == "CU" & year == current_year) %>% 
  select(median))

# calculate the differene in timing for current year species in DI compated to time series
so_timing_diff <- abs(so_q2_DI_current - so_q2_DI_TSA)

# Define whether the timing was earlier or later for use in inline text
so_later_or_earlier <- ifelse(so_q2_DI_current - so_q2_DI_TSA > 0, "later", "earlier")

# calculate the differene in timing for current year piecies in DI compated to time series
pi_timing_diff <- abs(pi_q2_DI_current - pi_q2_DI_TSA)

# Define whether the timing was earlier or later for use in inline text
pi_later_or_earlier <- ifelse(pi_q2_DI_current - pi_q2_DI_TSA > 0, "later", "earlier")

# calculate the differene in timing for current year cuecies in DI compated to time series
cu_timing_diff <- abs(cu_q2_DI_current - cu_q2_DI_TSA)

# Define whether the timing was earlier or later for use in inline text
cu_later_or_earlier <- ifelse(cu_q2_DI_current - cu_q2_DI_TSA > 0, "later", "earlier")

# Define function f here to convert Julian Days to dates
f <- function(x) {
  format(x + as.Date("2018-01-01") -1, format = "%B %d")
}

migration_timing <- peak_dates %>% 
  rename(Year = year, Species = species, Region = region, n = n, Q1 = q1, "Peak Date" = median,
         Q3 = q3) %>% 
  select(Year, Region, Species, Q1, "Peak Date", Q3, Spread) %>% 
  mutate_if(is.numeric, round) %>% 
  mutate(Q1 = f(Q1),
         "Peak Date" = f(`Peak Date`),
         Q3 = f(Q3))
         

```

```{r species proportions stats}

current_prop <- proportion %>% 
  filter(year == current_year) %>% 
  filter(species %in% c("so_total", "pi_total", "cu_total")) %>% 
  arrange(species)

so_prop <- round(100 * current_prop[3,4], 1) %>% as.numeric()
pi_prop <- round(100 * current_prop[2,4], 1) %>% as.numeric()
cu_prop <- round(100 * current_prop[1,4], 1) %>% as.numeric()

remaining <- 100 - (so_prop + pi_prop + cu_prop)

 
new_spp_names <- dplyr::recode(proportion$species, so_total = "Sockeye",
                               pi_total = "Pink", cu_total = "Chum",
                               he_total = "Herring", co_total = "Coho",
                               ck_total = "Chinook")

proportions_table <- proportion %>% 
  mutate(species = new_spp_names,
         proportion = round(proportion, 3)) %>% 
  rename(Year = year, Species = species, Proportion = proportion) %>% 
  select(Year, Species, Proportion) %>% 
  spread(key = Species, value = Proportion)
```

```{r sea lice stats}
# The idea here is to create an aggregated parasite index for both motile leps and caligus sealice for both regions separatlely and calculate abundance, prevalence and intensity according to Margolis et al. 1991.

sealice_summary_table$Year <- as.character(sealice_summary_table$Year)
# Create summary table to show in report

sealice_summary_table$Species <- factor(sealice_summary_table$Species) %>% 
  fct_relevel("SO", "PI", "CU") %>% 
  fct_recode("Sockeye" = "SO", "Pink" = "PI", "Chum" = "CU")

time_series_parasite_summary <- sealice_summary_table %>% 
  ungroup() %>% 
  group_by(Species, Region, louse_species) %>% 
  summarise(Prevalence_sd = sd(Prevalence),
            Prevalence = mean(Prevalence),
            Intensity_sd = sd(Intensity),
            Intensity = mean(Intensity),
            Abundance_sd = sd(Abundance),
            Abundance = mean(Abundance),
            n = sum(n)) %>% 
  mutate(Prevalence_se = Prevalence_sd / sqrt(n),
         Intensity_se = Intensity_sd/ sqrt(n),
         Abundance_se = Abundance_sd / sqrt(n)) %>% 
  mutate_if(is.numeric, round, 4) %>% 
  mutate("Prevalence, 95% CI" = paste(round(Prevalence,2), "+/-", 
                                      round(qt(1 - (0.05 / 2), n - 1) *
                                              Prevalence_se,2)),
         "Intensity, 95% CI" = paste(round(Intensity,2), "+/-", 
                                     round(qt(1 - (0.05 / 2), n - 1) *
                                             Intensity_se, 2)),
         "Abundance, 95% CI" = paste(round(Abundance,2), "+/-", 
                                     round(qt(1 - (0.05 / 2), n - 1) *
                                             Abundance_se, 2))) %>% 
  mutate(Year = paste(2015, "-", current_year)) %>% 
  select(Year, Region, Species, louse_species, n, Abundance, "Abundance, 95% CI",
         Prevalence, "Prevalence, 95% CI", Intensity, "Intensity, 95% CI") %>% 
  mutate_if(is.numeric, round, 2) %>% 
  mutate("Louse Species" = dplyr::recode(louse_species, all_lice = "Both Species",
                                         motile_caligus = "Motile Caligus",
                                         motile_lep = "Motile Lep")) %>% 
  select(Year, Region, Species, "Louse Species", n, "Abundance, 95% CI", "Prevalence, 95% CI", "Intensity, 95% CI")

sealice_table_pretty <- sealice_summary_table %>%
  filter(louse_species != "all_lice") %>% 
  mutate("Abundance, 95% CI" = paste0(Abundance, " +/- ", abundance_ci),
         "Prevalence, 95% CI" = paste0(Prevalence, " +/- ", prevalence_ci),
         "Intensity, 95% CI" = paste0(Intensity, " +/- ", intensity_ci)) %>% 
  mutate("Louse Species" = dplyr::recode(motile_caligus = "Motile Caligus",
                                         motile_lep = "Motile Lep")) %>% 
  select(Year, Region, Species, "Louse Species", n, "Abundance, 95% CI", "Prevalence, 95% CI", "Intensity, 95% CI")
```

```{r, length stats}
length_histo_current <- length_histo %>% 
  filter(year == current_year) %>% 
  mutate(category = current_year)

summary_lengths <- length_histo %>% 
  group_by(year, region, species) %>% 
  summarize(SD = sd(fork_length, na.rm = TRUE),
            fork_length = round(mean(fork_length),1),
            n = n()) %>% 
  mutate(SE = SD / sqrt(n),
         CI = qt(1 - (0.05 / 2), n - 1) * SE) %>% 
  arrange(year, region, desc(species)) %>% 
  select(year, region, species, n, fork_length, CI) %>% 
  mutate_if(is.numeric, round, 1) %>% 
  ungroup() %>% 
  mutate(year = as.character(year))

tsa_length <- summary_lengths %>% 
  ungroup() %>% 
  group_by(region, species) %>% 
  summarize(SD = sd(fork_length, na.rm = TRUE),
            fork_length = round(mean(fork_length),1),
            n = n()) %>% 
  mutate(SE = SD / sqrt(n),
         CI = qt(1 - (0.05 / 2), n - 1) * SE,
         year = paste(2015, "-", current_year)) %>% 
  arrange(year, region, desc(species)) %>% 
  select(year, region, species, n, fork_length, CI) %>% 
  mutate_if(is.numeric, round, 1) %>% 
  bind_rows(summary_lengths) %>% 
  mutate("95% CI" = paste(fork_length - CI, "-", fork_length + CI)) %>% 
  rename(Year = year, Region = region, Species = species, 
         "Fork Length (mm)" = fork_length) %>% 
  select(Year, Region, Species, n, "Fork Length (mm)", "95% CI")
  
len_tt <- length_histo %>% 
  mutate(category = 'tsa') %>% 
  rbind(length_histo_current) %>% 
  group_by(species) %>% 
  do(broom::tidy(t.test(.$fork_length ~ .$category))) %>% 
  arrange(desc(species))

```

```{r sst stats}
# SST z-score
## I'm going to filter the time period down to May and Juen because that's the most relevant period that juvenile salmon are likely to be in the Strait of Georgia

sst_annual_mean <- ctd_all %>%
  ungroup() %>%
  mutate(date = as_date(date)) %>%
  mutate(month = month(date), year = year(date)) %>%
  filter(month >= 5 & month <= 6, station == "QU39") %>%
  select(year, mean_temp) %>%
  group_by(year) %>%
  summarise(sd_temp = sd(mean_temp),
    mean_temp = mean(mean_temp, na.rm = T))
            

sst_mean <- mean(sst_annual_mean$mean_temp)
sst_sd <- sd(sst_annual_mean$mean_temp)

sst_z <- (sst_annual_mean$mean_temp - sst_mean) / sst_sd

sst_time_series_stats <- ctd_all %>%
  ungroup() %>%
  mutate(date = as_date(date)) %>%
  mutate(month = month(date), year = year(date)) %>%
  filter(month >= 5 & month <= 6, station == "QU39") %>%
  select(year, mean_temp) 

sst_current_year <- sst_time_series_stats %>% 
  filter(year == current_year)

sst_stats_table <- broom::tidy(t.test(sst_current_year$mean_temp, sst_time_series_stats$mean_temp))

sst_nice_table <- sst_annual_mean %>% 
  mutate(mean_temp = round(mean_temp, 2),
         sd_temp = round(sd_temp, 2)) %>% 
  select(Year = year, "Temperature (C)" = mean_temp, SD = sd_temp) 

```

# Introduction

  The first months after marine entry have been identified as a potentially critical period for salmon stock recruitment [@Beamish2001], which may ultimately be responsible for inter-annual variability and long-term declines in British Columbian salmon stocks [@Peterman2010; @Beamish2012]. Pathogens, parasites, predators, and the impacts of climate change on food web dynamics have emerged as leading causes for the declines (#TODO: add reference). The Hakai Institute Juvenile Salmon Program has been monitoring juvenile salmon migrations in the Discovery Islands and Johnstone Strait (Figure \@ref(fig:map)) since 2015 in an effort to understand the factors that may be influencing early marine survival of sockeye, pink, and chum [@Hunt2018]. This report summarizes migration timing, fish length, parasite loads, species composition, and sea-surface temperature observed from the first `r project_years` years of this research and monitoring program. These estimates will provide the context to investigate questions and interpret results related to growth, survival, and the conditions salmon experience during their migration through this critical region. 

```{r map, fig.cap = "Sampling locations in 2018", fig.align='left', out.width="90%"}
include_graphics('map.png')
```

# Methods

## Field methods

  See Hunt et al. (2018) for a detailed description of field and lab methods. Briefly, juvenile salmon were collected weekly from the Discovery Islands and Johnstone Strait during their northward migration from the Strait of Georgia to Queen Charlotte Strait near northern Vancouver Island, British Columbia. We sampled from May to July each year, beginning in 2015, using hand-operated purse seine nets (bunt: 27 m x 9 m with 13 mm mesh; tow: 46 m x 9 m with 76 mm mesh) [@Godwin2015]. We sampled near-shore marine habitats where depth was > 10 m, effectively sampling sockeye (_Oncorhynchus nerka_), pink (_O. gorbuscha_) and chum (_O. keta_) salmon, and incidentally captured coho (_O. kisutch_), Chinook (_O. tshawytschya_) and Pacific herring (_Clupea pallasii_). All animal care was in accordance with Animal Care Guidelines under permit A16-0101. We collected temperature data by deploying an RBR conductivity, temperature, and depth profiler to depths > 30 m at station QU39 (Figure \@ref(fig:map)) in the northern Strait of Georgia.

## Data Analysis

  Time series anomalies reported are in relation to the time series averages (2015-`r current_year`). Measurements from the Discovery Islands and Johnstone Strait regions of the salmon migration were combined in analyses unless otherwise indicated. Only sites that were sampled in all years were used. All analyses were conducted using R  [@R].

Add clarifying sentence here about why abundance and catch intensity is based on seines that contained sockeye.

  The peak migration date for each species was estimated by calculating the median date of capture in the Discovery Islands. This method was used because the period in which surveys and seines were conducted was the same each year and seines were always conducted before sockeye arrived and after sockeye disappeared. Often, however, the entire duration of the pink and chum migration through the Discovery Islands was not captured because their migration period is more protracted compared to sockeye. Cumulative abundance was calculated over a constrained period between May 1 and July 9 of each year to standardize the period over which cumulative abundance was calculated. Because the Fraser River is currently an even-year-dominant system for pink salmon, very few out-migrating pink are caught in odd years; consequently, only even years were included in the calculation of the pink time series average.

  In 2015 and 2016 we focussed on capturing sockeye and we only enumerated and sampled other species such as pink and chum when sockeye were caught. As a result, catch statistics such as catch intensity and proportion reflect the fact that we only unumerated and sampled salmon when sockeye were caught. In 2017 and 2018 all seines that captured any species of salmon were enumerated and sampled. These differences in methodology are reflected in the way catch intensity and catch proportions are calculated in so far as catch intensity and catch proportion calculations are restricted to when sockeye were present.
  
  Catch intensity was calculated to provide a measure of inter-annual abundance for sockeye, pink, and chum. Catch intensity was defined as the average number of a species caught when > 1 of that particular species was caught, and when sockeye were also caught. In effect, catch intensity summarizes the abundance of each species in a community of co-migrating sockeye, pink, and chum when sockeye are present.
  
  Species proportions were calculated by dividing the total number of each species caught by the sum of all species caught that season. Only seines that caught sockeye were used in the calculation of species to represent the salmon community composition that co-migrate with sockeye. To test whether fork lengths from `r current_year` were significantly different than the time series averages, an independent two-group t-test was conducted. Fork length distributions were visualized by calculating length frequency distributions using kernel density estimates from fork length data.
  
  The prevalence, intensity, and abundance of _Caligus clemensi_ and _Lepeophtheirus salmonis_ sea lice were calculated according to the definitions in @Margolis1990. Only motile (i.e., pre-adult and adult) stages were included in analyses while nauplius, copepodid, and chalimus life stages were excluded.
  
  The mean sea-surface temperature (SST) was calculated from the top 30 m of the water column in May and June--the period during which salmon migrate through the region. To visualize temperature anomalies, a LOESS regression was applied to sea-surface temperatures from all years to represent the average seasonal trend. 

# Results and Discussion

  Most migration parameters were below average in 2018 except for sockeye length and SST (Figure \@ref(fig:heatmap)). Interestingly, sockeye length tends to be the opposite anomaly compared to pink and chum which vary together.

Migration timing in the Discovery Islands in 2018 did not differ from the time series average by more than a week for sockeye, pink, or chum (Figure \@ref(fig:migration-timing-plot)) (Table \@ref(tab:migration-timing-table)). The peak migration date for sockeye in the Discovery Islands was on `r f(so_q2_DI_current)`, `r round(so_timing_diff)` days `r so_later_or_earlier` than the time series average of `r f(so_q2_DI_TSA)`. The peak migration date for pink in the Discovery Islands was on `r f(pi_q2_DI_current)`, `r round(pi_timing_diff)` days `r pi_later_or_earlier` than the average of `r f(pi_q2_DI_TSA)`. The peak migration date for chum in the Discovery Islands was on `r f(cu_q2_DI_current)`, `r round(cu_timing_diff)` days `r cu_later_or_earlier` than the average of `r f(cu_q2_DI_TSA)`.

Sockeye catch intensity in 2018 was low relative to sockeye in previous years and relative to pink and chum in 2018 (Figure \@ref(fig:catch-intensity-plot)). That sockeye catch intensity was low in 2018 is not surprising because 2016 brood year Shuswap or Chilko Lake sockeye, two stocks which are among the most productive, are not as abundant in this cohort as they are in others. Pink catch intensity in 2018 was the highest of the four years measured. Pink out-migrants are more abundant on even years, the result of the odd-year dominant life-cycle of Fraser River pinks [@Heard1991], but 2018 catches indicate either good production or good survival in the early marine environment for pink salmon relative to 2016—the only other odd-year dominant brood year recorded by the Juvenile Salmon Program.

Pink salmon dominated the catch in the Discovery Islands and Johnstone in 2018 making up `r pi_prop` % of the catch (Table \@ref(tab:proportion-table)) while chum made up `r cu_prop` % and sockeye `r so_prop` % (Figure \@ref(fig:proportion-plot)). This was the first time in the time series that pink dominated the catch proportion.

Fish lengths varied between regions, and among species and years (Figure \@ref(fig:length-plot)) though in `r current_year` sockeye were `r ifelse(len_tt[1,2] > 0, "longer", "shorter")`, pink were `r ifelse(len_tt[2,2] > 0, "longer", "shorter")`, and chum were `r ifelse(len_tt[3,2] > 0, "longer", "shorter")` than their respective time series averages in the Discovery Islands and Johnstone Strait combined. Sockeye length was `r round(len_tt[1,3],1)` mm (Table \@ref(tab:length-table)), which is `r abs(round(len_tt[1,2],1))` mm `r ifelse(len_tt[1,2] > 0, "longer", "shorter")` than the time series average (_p_ < 0.0001, 95% CI `r abs(round(len_tt[1,8],1))` -`r abs(round(len_tt[1,9],1))`). Average pink lengths were `r round(len_tt[2,3],1)` mm, which is `r abs(round(len_tt[2,2],1))` mm `r ifelse(len_tt[2,2] > 0, "longer", "shorter")` than the time series average (_p_ < 0.0001, 95% CI `r abs(round(len_tt[2,8],1))`-`r abs(round(len_tt[2,9],1))`). Chum  were on average `r round(len_tt[3,3],1)` mm, which is `r abs(round(len_tt[3,2],1))` mm  `r ifelse(len_tt[3,2] > 0, "longer", "shorter")` than the time series average (_p_ < 0.0001, 95% CI `r abs(round(len_tt[3,8],1))`-`r round(len_tt[3,9],1)`).

The abundance of motile sea lice in 2018 was the among the lowest recorded in the Discovery Islands time-series while Johnstone Strait parasite loads were average. (Figure \@ref(fig:sealice-abundance-plot)). Notably, no _Lepeophtheirus salmonis_ were detected on sockeye in Johnstone Strait, despite being present in the Discovery Islands. The time series averages indicate pink salmon have higher sea lice abundance, prevalence, and intensity compared to the chum, and sockeye (Table \@ref(tab:sealice-table)) in contrast to @Patanasatienkul2013 where they found that the prevalence and intensity of sea lice was higher on chum than pink on early marine entrants in the Broughton Archipelago.

Sea-surface temperature in May and June during the juvenile salmon out-migration at QU39 in the northern Strait of Georgia was `r round(sst_stats_table$estimate, 2)` degrees C warmer than average (Table \@ref(tab:sst-table)) (Figure \@ref(fig:sst-plot)). In the context of the last four last years 2018 was the warmest surface waters observed in the northern Strait of Georgia, despite 2015 SST along the BC coast breaking records for high temperatures [@Chandler2017]. 

```{r heatmap,  fig.cap = "This heatmap indicates the number of standard deviations (z-score) from the time series average (2015-2018) for key migration parameters. Size and colour saturation of circles indicates magnitude of the anomaly. Blue colour indicates less than average, grey indicates average, red indicates greater than average. Peak migration date is based on the median date of fish capture in the Discovery Islands. Length is based on the average fork length from the Discovery Islands and Johnstone Strait combined. Parasite load is the average abundance of all sea-louse species in their motile life stages for both the Discovery Islands and Johnstone Strait regions. “SST” describes the mean sea-surface temperature in the top 30 m at station QU39 in the northern Strait of Georgia in May and June.", out.width = "95%", fig.height=5.5, fig.width=8}

cols <- c("#4575b4",
          "lightgrey",
          "#d73027"
          )

ggplot(heatmap_data, aes(year, metric, colour = Z)) +
  geom_point(size = abs(10 * heatmap_data$Z), alpha = 0.1) +
  geom_point(aes(size = abs(10 * Z)), show.legend = F) +
  scale_size_continuous(range = c(3,15)) +
  ylab("") +
  xlab("Year") +
  scale_colour_gradientn(colours = cols) +
  theme(legend.position = "bottom") +
  guides(color = guide_legend(override.aes = list(size = c(10, 6, 3, 6, 10), alpha = 1)), name = "Standard\nDeviations") +
  labs(color = "Standard\nDeviations") +
  scale_y_discrete(expand = expand_scale(mult = c(.1, .1))) +
  scale_x_continuous(expand = expand_scale(mult = c(.1, .1)), minor_breaks = 0) +
  ggtitle("Time Series Anomalies") +
  theme(panel.grid.major.y= element_line("grey"))

ggsave(here("figs", "heatmap.png"))
```


```{r migration-timing-plot, fig.cap = "Cumulative annual abundance of sockeye, pink, and chum, in the Discovery Islands and Johnstone Strait compared to the time series average.", out.width="90%"}
cols <-
  c(
    "2015-2018" = "black",
    "2018" = "#F8766D",
    "2017" = "#7CAE00",
    "2016" = "#00BFC4",
    "2015" = "#C77CFF"
  )
shapes <-
  c(
    "2015-2018" = "triangle",
    "2018" = "circle",
    "2017" = "circle",
    "2016" = "circle",
    "2015" = "circle"
  )

predict_average_prop <- predict_average_prop %>% 
  filter(region == "DI")

predict_average_prop$species <- factor(predict_average_prop$species) %>% 
  fct_relevel(c("Sockeye", "Pink", "Chum"))

predict_annual_prop$species <- factor(predict_annual_prop$species) %>% 
  fct_relevel(c("Sockeye", "Pink", "Chum"))

ggplot()+
      labs(x = 'Date', y = 'Cumulative Catch %') +
      geom_line(data = predict_average_prop, aes(x = x, y = y, color = year), size = 2, alpha = 0.8) +
      
      geom_line(data = predict_annual_prop, aes(x = x, y = y, color = as.factor(year)), size = 1.25, alpha = 0.8, linetype = "longdash") +
  geom_point(data = cu_cum_abund_annual_DI_2017, aes(x = survey_date, y = percent, colour = factor(year))) +
  geom_point(data = cu_cum_abund_annual_DI_2017, aes(x = survey_date, y = percent, colour = factor(year))) + 
  # geom_smooth(data = cu_cum_abund_2017, aes(x = survey_date, y = percent,
  #                                           colour = factor(year)), span = 1, se = FALSE) +
  scale_linetype_manual(values = c("dashed")) +
      scale_x_continuous(breaks = c(135, 152, 166, 182, 196), 
                         labels = c("May 15", "June 1", "June 15", "July 1", "July 15")) +
      coord_cartesian(xlim = c(128, 190)) + 
      scale_shape_manual(values = shapes) +
      scale_colour_manual(values = cols, name="",
                         breaks=c("2015-2018", "2015", "2016", "2017", "2018"),
                         labels=c("Average", "2015", "2016", "2017", "2018")) +
  theme(legend.position = c(0.9, 0.5)) +
  theme(panel.grid.major.y= element_line("#DCDCDC")) +
  theme(panel.grid.major.x= element_line("#DCDCDC")) +
  facet_grid(species ~ .) +
  ggtitle("Migration Timing")
    
ggsave(here("figs", "migration_timing.png"))
```

```{r condition}

time_series_fish_cond <- fish_cond %>% 
  mutate(year = factor(year(date))) %>% 
  filter(species == "SO",
         year != current_year) %>% 
  mutate(Years = "Time series")

current_fish_cond <- fish_cond %>% 
  filter(Years == current_year) %>% 
  mutate(Years == current_year)

ggplot(data = fish_cond, aes(x = fork_length, y = weight, colour= Years)) +
  geom_point(data = time_series_fish_cond, alpha = .2) +
  geom_point(data = current_fish_cond, alpha = .5) + 
  ylab('Weight (g)')+
  xlab('Length (mm)')+
  labs(title = "Sockeye Length Weight Relationship",
       subtitle = paste(current_year, "in red compared to time series")) +
  coord_cartesian(xlim = c(60, 165), ylim = c(0, 50)) +
  scale_color_manual(values=c("#B52025", "black")) +
  theme(legend.position = c(.9, .15), legend.title=element_blank())

ggsave(here("figs", "length_weight.png"))

```

```{r catch-intensity-plot, fig.cap = "The catch intensity (our proxy for abundance) of sockeye, pink, and chum salmon in the Discovery Islands and Johnstone Strait. Numbers under each bar indicate the number of seines in which the species was caught, and erorr bars indicate the 95 percent confidence region.", out.width="90%"}

catch_intensity$species <- catch_intensity$species %>% 
  fct_relevel("Sockeye", "Pink", "Chum")

ggplot(catch_intensity, aes(x = factor(year), y = mean_catch, fill = species)) +
  geom_bar(colour = "black", stat="identity", position=position_dodge()) +
  geom_errorbar(aes(ymin = mean_catch - lower_ci,
                        ymax = mean_catch + upper_ci),
                    width = 0.2,
                    position = position_dodge(0.9)) +
  geom_text(aes(y = 0.0, label = paste0(n)), size = 3.15, vjust = 1.25,
                position = position_dodge(0.9)) +
  xlab("Year") +
  ylab("Catch Intensity") +
  scale_fill_hakai()+
  labs(fill = "Species") +
  ggtitle("Species Abundance Proxy")

ggsave(here("figs", "catch_intesity.png"))
```

```{r proportion-plot, out.width="90%", fig.cap="The annual proportion of fish captured in the Discovery Islands and Johnstone Strait combined."}
    
proportion$species <- proportion$species %>% 
  fct_relevel("so_total", "pi_total", "cu_total", "co_total", "he_total") %>% 
  fct_recode("Sockeye" = "so_total", "Pink" = "pi_total", "Chum" = "cu_total", "Coho" = "co_total",
             "Herring" = "he_total")

    ggplot(data = proportion, aes(x = year, y = proportion, fill = species)) +
      geom_bar(colour = "black", stat="identity", position = 'stack') +
      xlab("Year") +
      ylab("Proportion") +
      scale_fill_hakai() +
      labs(fill = "Species") +
      ggtitle("Species Proportions")

ggsave(here("figs", "proportions.png"))
```

```{r length-plot, out.width="90%", fig.cap="Distributions of juvenile salmon fork lengths for each year in the Discovery Islands and Johnstone Strait. Note that these distributions contain multiple age classes."}

length_histo$species <- length_histo$species %>% 
  fct_relevel("SO", "PI", "CU")

ggplot(length_histo, aes(fork_length, y = factor(year), fill = species)) +
  geom_density_ridges(color='black', scale = 3, alpha = 0.9) +
  xlab("Fork Length (mm)") +
  facet_grid(species ~ ., labeller = labeller(region = spp_labels, species = spp_labels)) +
  ylab("Year") +
  scale_fill_hakai() +
  scale_y_discrete(expand = expand_scale(add = c(0.2, 2.8))) +
  coord_cartesian(xlim = c(60, 160)) +
  guides(fill = FALSE) +
  ggtitle("Fork Length Frequency Distributions")

ggsave(here("figs", "lengths.png"))
```

```{r sealice-abundance-plot, fig.cap="The abundance of motile sea lice on juvenile salmon in the Discovery Islands and Johnstone Strait. The numbers under each bar indicate the sample size and the error bars indicate the 95 percent confidence region.", out.width="90%"}

sealice_summary_table %>% 
  select(Year, Region, Species, louse_species, n, Abundance, abundance_ci) %>% 
  filter(louse_species != "all_lice") %>% 
  mutate(louse_species = dplyr::recode(.$louse_species, motile_caligus = "C. clemensi", motile_lep = "L. salmonis")) %>% 
  ggplot(aes(x = Year, y = Abundance, fill = louse_species,
                 group = louse_species)) +
      geom_bar(colour = "black", stat = "identity", position = position_dodge()) +
      geom_errorbar(aes(ymin = Abundance - abundance_ci, 
                        ymax = Abundance + abundance_ci), 
                    width = 0.2,
                    position = position_dodge(0.9)) +
      facet_grid(Region ~ Species,
                 labeller = labeller(Region = spp_labels)) +
      labs(x = "Year", y = "Abundance") +
      theme(legend.position="bottom") +
      # geom_text(aes(label = ifelse(Abundance == 0, round(Abundance, 1), '')),
      #          position = position_dodge(0.9), vjust = -0.5) +
      # geom_text(aes(y = 0.0, label = paste0(n)), size = 3.15, vjust = 1.25,
      #           position = position_dodge(0.9)) +
      scale_y_continuous(expand = expand_scale(mult = c(.15, 0))) +
      scale_fill_hakai() +
      labs(fill = "Louse Species") + 
  theme(legend.text = element_text(face = "italic", size = 10)) +
  ggtitle("Sea Lice Abundance")

ggsave(here("figs", "sealice_abundance.png"))
```

```{r sealice-prevalence-plot, fig.cap="The prevalence of motile sea lice on juvenile salmon in the Discovery Islands and Johnstone Strait. The numbers under each bar indicate the sample size and the error bars indicate the 95 percent confidence region.", out.width="90%"}
 
sealice_summary_table %>% 
  select(Year, Region, Species, louse_species, n, Prevalence, prevalence_ci) %>% 
  filter(louse_species != "all_lice") %>% 
  mutate(louse_species = dplyr::recode(.$louse_species, motile_caligus = "C. clemensi", motile_lep = "L. salmonis")) %>% 
  ggplot(aes(x = Year, y = Prevalence, fill = louse_species,
                 group = louse_species)) +
      geom_bar(colour = "black", stat = "identity", position = position_dodge()) +
      geom_errorbar(aes(ymin = Prevalence - prevalence_ci, 
                        ymax = Prevalence + prevalence_ci), 
                    width = 0.2,
                    position = position_dodge(0.9)) +
      facet_grid(Region ~ Species, 
                 labeller = labeller(Region = spp_labels)) +
      labs(x = "Year", y = "Prevalence") +
      theme(legend.position="bottom") +
      geom_text(aes(label = ifelse(Prevalence == 0, round(Prevalence, 1), '')),
               position = position_dodge(0.9), vjust = -0.5) +
      # geom_text(aes(y = 0.0, label = paste0(n)), size = 3.15, vjust = 1.25,
      #           position = position_dodge(0.9)) +
      # scale_y_continuous(expand = expand_scale(mult = c(.15, 0))) +
      scale_fill_hakai() +
      labs(fill = "Louse Species") + 
      theme(legend.text = element_text(face = "italic", size = 10)) +
      ggtitle("Sea Lice Prevalence")

ggsave(here("figs", "sealice_prevalence.png"))

```

```{r sealice-intensity-plot, fig.cap="The intensity of motile sea lice (average number of lice when > 1 louse is present) on juvenile salmon in the Discovery Islands and Johnstone Strait. The numbers under each bar indicate the sample size and the error bars indicate the 95 percent confidence region.", out.width="90%"}
 
sealice_summary_table %>% 
  select(Year, Region, Species, louse_species, n, Intensity, intensity_ci) %>% 
  filter(louse_species != "all_lice") %>% 
  mutate(louse_species = dplyr::recode(.$louse_species, motile_caligus = "C. clemensi", motile_lep = "L. salmonis")) %>% 
  ggplot(aes(x = Year, y = Intensity, fill = louse_species,
                 group = louse_species)) +
      geom_bar(colour = "black", stat = "identity", position = position_dodge()) +
      geom_errorbar(aes(ymin = Intensity - intensity_ci, 
                        ymax = Intensity + intensity_ci), 
                    width = 0.2,
                    position = position_dodge(0.9)) +
      facet_grid(Region ~ Species, 
                 labeller = labeller(Region = spp_labels)) +
      labs(x = "Year", y = "Intensity") +
      theme(legend.position="bottom") +
      geom_text(aes(label = ifelse(Intensity == 0, round(Intensity, 1), '')),
               position = position_dodge(0.9), vjust = -0.5) +
      # geom_text(aes(y = 0.0, label = paste0(n)), size = 3.15, vjust = 1.25,
      #           position = position_dodge(0.9)) +
      # scale_y_continuous(expand = expand_scale(mult = c(.15, 0))) +
      scale_fill_hakai() +
  coord_cartesian(ylim = c(0,2.5)) +
      labs(fill = "Louse Species") + 
  theme(legend.text = element_text(face = "italic", size = 10)) +
  ggtitle("Sea Lice Intensity")

ggsave(here("figs", "sealice_intensity.png"))
```

```{r sst-plot, out.width="90%", fig.cap="Sea-surace temperature (top 30 m) at station QU39 in the northern Strait of Georgia is the solid black line which is a LOESS regression based on temperatures from 2015-2018 representing the time series average. Blue areas represent temperatures from 2018 that are below average, red areas represent above average temperatures. The shaded grey area is 1 SE of the LOESS regression. The black dots are the daily minimum and maximum temperatures observed over the time series."}

temperature_anomaly_data <- temperature_anomaly_data %>% 
      filter(station == "QU39")
    
    min_max_data <- min_max_data %>% 
      filter(station == "QU39")
    
    average_temps <- average_temps %>% 
      filter(station == "QU39")

ggplot(data = temperature_anomaly_data, aes(x = yday, y = mean_temp)) +
      geom_point(aes(x = yday, y = predicted_mean_temp), size = 0.1)+
      geom_line(aes(x = yday, y = predicted_mean_temp)) +
      geom_ribbon(data = subset(temperature_anomaly_data, 
                                mean_temp >= predicted_mean_temp),
                  aes(ymin = predicted_mean_temp, ymax = mean_temp),
                  fill = 'red', size = 1)+
      geom_ribbon(data = subset(temperature_anomaly_data, 
                                mean_temp <= predicted_mean_temp), 
                  aes(ymin = mean_temp, ymax = predicted_mean_temp),
                  fill = 'blue', size = 1)+
      geom_smooth(data = average_temps, aes(x = yday, y = mean_temp),
                  size = 1, colour = 'black', se = T, span = .65) +
      geom_point(data = min_max_data,
                 aes(x = yday, y = min_temp), size = 0.5) +
      geom_point(data = min_max_data,
                 aes(x = yday, y = max_temp), size = 0.5) + 
      scale_x_continuous(breaks = (c(32, 60, 91, 121, 152, 182, 213)),
                         labels = (c("Feb", "Mar", "Apr", "May", "Jun", 
                                     "Jul", "Aug"))) +
      labs(x = "Date", y = "Temperature [°C]") +
      coord_cartesian(xlim = c(32,213)) +
  ggtitle("Sea-surface Temperature Anomalies")

ggsave(here("figs", "sst.png"))

```

# Tables

```{r z-scores-table}
heatmap_data <- heatmap_data %>% 
  select(year, metric, Estimate, SD, Z)
knitr::kable(heatmap_data, col.names = c("Year", "Parameter", "Estimate", "SD", "Z score"), format = 'markdown')
```
Table: (\#tab:z-scores-table) Key salmon health, growth, and migration annual estimates. Migration timing estimates are the median capture date in the Discovery Islands, catch intensity estimates are the mean catch when greater than one sockeye are caught in the Discovery Islands and Johnstone Strait combined, length estimates are the mean fork length (mm) in both regions combined, parasite loads are mean abundance for motile lice from both regions combined, and SST is the mean sea-surface temperature in degrees celcius at station QU39 in the northern Strait of Georgia. Standard deviation is denoted by SD and is the within-year standard deviation (note no SD for median capture dates). Z score is the number of standard deviations the annual estimate is away from the time series mean.

```{r time-series-table}

#TODO Take the time series averages that are diplayed in the bubble plot and make a table.



```

```{r migration-timing-table}
knitr::kable(migration_timing, format = 'markdown')
```
Table: (\#tab:migration-timing-table) Migration timing statistics for the cumulative catch of sockeye, pink, and chum salmon in the Discovery Islands in 2018, compared to the time-series average (2015 - `r current_year`). Q1 is when 25 % of the species passed through the regions, peak date is the median when 50 % passed through, Q3 is 75%, and Spread is the difference between Peak Date and Q1. The region DI indicates the Discovery Islands while for species SO is sockeye, PI is pink, and CU is chum. 

```{r catch-intensity-table}
catch_intensity <- catch_intensity %>% 
  select("year", "species", "mean_catch")

knitr::kable(catch_intensity, format = 'markdown', 
             col.names = c("Year", "Species", "Catch Intensity"))
```
Table: (\#tab:catch-intensity-table) Catch intensity—our proxy for abundance—for sockeye, pink, and chum in the Discovery Islands and Johnstone Strait combined.


```{r length-table}
summary_lengths <- summary_lengths %>% 
  select(Year = year, Region = region, Species = species, N = n, "Fork Length" = fork_length, CI = CI)
knitr::kable(summary_lengths, format = 'markdown')
```
Table: (\#tab:length-table) Mean fork lengths for each year, species, and region with the 95 % confidence interval (95% CI). The column n indicates the number of fish measured.

```{r proportion-table}
knitr::kable(proportions_table, format = 'markdown')
```
Table: (\#tab:proportion-table) The species proportions of total catch in each year for sockeye, pink, chum, herring, coho, and Chinook.


```{r sealice-table}

sealice_table_pretty <- sealice_table_pretty %>% 
  filter(Species !)
  
knitr::kable(sealice_table_pretty, format = 'markdown', caption = "Mean sea-lice loads (with 95% CI calculated from annual averages) ")

```
Table: (\#tab:sealice-table) Mean sea-louse abundance, prevalence, and intensity (as defined in Margolis et al. 1990) across the time series (2015-`r current_year`) for each fish, region, and year. 95% confidence intervals were calculated from annual averages. The region DI indicates the Discovery Islands and JS Johnstone Strait.

# References





